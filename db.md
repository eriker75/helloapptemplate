-- DROP SCHEMA public;

CREATE SCHEMA public AUTHORIZATION pg_database_owner;

COMMENT ON SCHEMA public IS 'standard public schema';

-- DROP SEQUENCE public.chat_members_id_seq;

CREATE SEQUENCE public.chat_members_id_seq
 INCREMENT BY 1
 MINVALUE 1
 MAXVALUE 9223372036854775807
 START 1
 CACHE 1
 NO CYCLE;

-- Permissions

ALTER SEQUENCE public.chat_members_id_seq OWNER TO postgres;
GRANT ALL ON SEQUENCE public.chat_members_id_seq TO postgres;
GRANT ALL ON SEQUENCE public.chat_members_id_seq TO anon;
GRANT ALL ON SEQUENCE public.chat_members_id_seq TO authenticated;
GRANT ALL ON SEQUENCE public.chat_members_id_seq TO service_role;
-- public.chat_members definition

-- Drop table

-- DROP TABLE public.chat_members;

CREATE TABLE public.chat_members ( id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL, created_at timestamptz DEFAULT now() NOT NULL, updated_at timestamp DEFAULT now() NULL, chat_id uuid DEFAULT gen_random_uuid() NULL, user_id uuid DEFAULT gen_random_uuid() NULL, joined_at timestamp NULL, "role" varchar NULL, CONSTRAINT chat_members_pkey PRIMARY KEY (id));
COMMENT ON TABLE public.chat_members IS 'users from chat';

-- Permissions

ALTER TABLE public.chat_members OWNER TO postgres;
GRANT ALL ON TABLE public.chat_members TO postgres;
GRANT ALL ON TABLE public.chat_members TO anon;
GRANT ALL ON TABLE public.chat_members TO authenticated;
GRANT ALL ON TABLE public.chat_members TO service_role;

-- public.chats definition

-- Drop table

-- DROP TABLE public.chats;

CREATE TABLE public.chats ( created_at timestamptz DEFAULT now() NOT NULL, updated_at timestamp DEFAULT now() NULL, is_active bool NULL, "type" varchar NULL, last_message_id uuid DEFAULT gen_random_uuid() NULL, description text NULL, creator_id uuid DEFAULT gen_random_uuid() NULL, "name" varchar NULL, id uuid DEFAULT gen_random_uuid() NOT NULL, CONSTRAINT chats_pkey PRIMARY KEY (id));
COMMENT ON TABLE public.chats IS 'wrapper | grouper - of chat messages';

-- Permissions

ALTER TABLE public.chats OWNER TO postgres;
GRANT ALL ON TABLE public.chats TO postgres;
GRANT ALL ON TABLE public.chats TO anon;
GRANT ALL ON TABLE public.chats TO authenticated;
GRANT ALL ON TABLE public.chats TO service_role;

-- public.messages definition

-- Drop table

-- DROP TABLE public.messages;

CREATE TABLE public.messages ( id uuid DEFAULT gen_random_uuid() NOT NULL, created_at timestamptz DEFAULT now() NOT NULL, updated_at timestamp DEFAULT now() NULL, chat_id uuid DEFAULT gen_random_uuid() NULL, "content" text NULL, sender_id uuid DEFAULT gen_random_uuid() NULL, parent_id uuid DEFAULT gen_random_uuid() NULL, draft_content varchar NULL, "type" varchar NULL, readed bool NULL, deleted bool NULL, CONSTRAINT messages_pkey PRIMARY KEY (id));
COMMENT ON TABLE public.messages IS 'conversation messages';

-- Permissions

ALTER TABLE public.messages OWNER TO postgres;
GRANT ALL ON TABLE public.messages TO postgres;
GRANT ALL ON TABLE public.messages TO anon;
GRANT ALL ON TABLE public.messages TO authenticated;
GRANT ALL ON TABLE public.messages TO service_role;

-- public.profiles definition

-- Drop table

-- DROP TABLE public.profiles;

CREATE TABLE public.profiles ( id uuid DEFAULT gen_random_uuid() NOT NULL, created_at timestamptz DEFAULT (now() AT TIME ZONE 'utc'::text) NOT NULL, updated_at timestamp DEFAULT (now() AT TIME ZONE 'utc'::text) NULL, alias varchar NULL, bio varchar NULL, birth_date timestamp NULL, gender int2 NULL, interested_in jsonb NULL, avatar varchar NULL, address varchar NULL, preferences jsonb NULL, last_online timestamp NULL, "location" varchar NULL, user_id uuid DEFAULT gen_random_uuid() NULL, is_onboarded int2 DEFAULT '0'::smallint NULL, status int2 DEFAULT '1'::smallint NULL, is_verified int2 DEFAULT '0'::smallint NULL, latitude numeric NULL, longitude numeric NULL, CONSTRAINT profiles_pkey PRIMARY KEY (id));
COMMENT ON TABLE public.profiles IS 'Additional info of users';

-- Column comments

COMMENT ON COLUMN public.profiles.is_onboarded IS 'manage boolean 0 No onboarded or 1 Onboarded condition';
COMMENT ON COLUMN public.profiles.status IS '1 ACTIVE - 0 INACTIVE';
COMMENT ON COLUMN public.profiles.is_verified IS '1 is verified, 0 NOT verified';

-- Permissions

ALTER TABLE public.profiles OWNER TO postgres;
GRANT ALL ON TABLE public.profiles TO postgres;
GRANT ALL ON TABLE public.profiles TO anon;
GRANT ALL ON TABLE public.profiles TO authenticated;
GRANT ALL ON TABLE public.profiles TO service_role;

-- public.chat_members foreign keys

ALTER TABLE public.chat_members ADD CONSTRAINT chat_members_chat_id_fkey FOREIGN KEY (chat_id) REFERENCES public.chats(id);
ALTER TABLE public.chat_members ADD CONSTRAINT chat_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id);

-- public.chats foreign keys

ALTER TABLE public.chats ADD CONSTRAINT chats_creator_id_fkey FOREIGN KEY (creator_id) REFERENCES auth.users(id);

-- public.messages foreign keys

ALTER TABLE public.messages ADD CONSTRAINT messages_chat_id_fkey FOREIGN KEY (chat_id) REFERENCES public.chats(id);
ALTER TABLE public.messages ADD CONSTRAINT messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES auth.users(id);

-- public.profiles foreign keys

ALTER TABLE public.profiles ADD CONSTRAINT profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE ON UPDATE CASCADE;

-- DROP FUNCTION public.handle_new_user();

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  INSERT INTO public.profiles (user_id)
  VALUES (NEW.id);
  RETURN NEW;
END;
$function$
;

-- Permissions

ALTER FUNCTION public.handle_new_user() OWNER TO postgres;
GRANT ALL ON FUNCTION public.handle_new_user() TO public;
GRANT ALL ON FUNCTION public.handle_new_user() TO postgres;
GRANT ALL ON FUNCTION public.handle_new_user() TO anon;
GRANT ALL ON FUNCTION public.handle_new_user() TO authenticated;
GRANT ALL ON FUNCTION public.handle_new_user() TO service_role;

-- DROP FUNCTION public.nearby_profiles(float8, float8, float8);

CREATE OR REPLACE FUNCTION public.nearby_profiles(user_lat double precision, user_lng double precision, max_distance double precision)
 RETURNS TABLE(user_id uuid, username text, avatar_url text, latitude double precision, longitude double precision, distance_km double precision)
 LANGUAGE sql
 SECURITY DEFINER
AS $function$
  SELECT
    p.user_id,
    p.alias AS username,
    p.avatar AS avatar_url,
    p.latitude::float,
    p.longitude::float,
    ST_Distance(
      ST_SetSRID(ST_MakePoint(user_lng, user_lat), 4326)::geography,
      ST_SetSRID(ST_MakePoint(p.longitude, p.latitude), 4326)::geography
    ) / 1000 AS distance_km
  FROM profiles p
  WHERE
    ST_DWithin(
      ST_SetSRID(ST_MakePoint(user_lng, user_lat), 4326)::geography,
      ST_SetSRID(ST_MakePoint(p.longitude, p.latitude), 4326)::geography,
      max_distance * 1000
    )
    AND p.user_id != auth.uid()
    AND p.status = 1  -- Solo usuarios activos
  ORDER BY distance_km ASC;
$function$
;

-- Permissions

ALTER FUNCTION public.nearby_profiles(float8, float8, float8) OWNER TO postgres;
GRANT ALL ON FUNCTION public.nearby_profiles(float8, float8, float8) TO public;
GRANT ALL ON FUNCTION public.nearby_profiles(float8, float8, float8) TO postgres;
GRANT ALL ON FUNCTION public.nearby_profiles(float8, float8, float8) TO anon;
GRANT ALL ON FUNCTION public.nearby_profiles(float8, float8, float8) TO authenticated;
GRANT ALL ON FUNCTION public.nearby_profiles(float8, float8, float8) TO service_role;

-- Permissions

GRANT ALL ON SCHEMA public TO pg_database_owner;
GRANT USAGE ON SCHEMA public TO public;
GRANT USAGE ON SCHEMA public TO postgres;
GRANT USAGE ON SCHEMA public TO anon;
GRANT USAGE ON SCHEMA public TO authenticated;
GRANT USAGE ON SCHEMA public TO service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT INSERT, DELETE, TRUNCATE, UPDATE, TRIGGER, SELECT, REFERENCES, MAINTAIN ON TABLES TO postgres;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT INSERT, DELETE, TRUNCATE, UPDATE, TRIGGER, SELECT, REFERENCES, MAINTAIN ON TABLES TO anon;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT INSERT, DELETE, TRUNCATE, UPDATE, TRIGGER, SELECT, REFERENCES, MAINTAIN ON TABLES TO authenticated;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT INSERT, DELETE, TRUNCATE, UPDATE, TRIGGER, SELECT, REFERENCES, MAINTAIN ON TABLES TO service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO postgres;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO anon;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO authenticated;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT UPDATE, SELECT, USAGE ON SEQUENCES TO postgres;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT UPDATE, SELECT, USAGE ON SEQUENCES TO anon;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT UPDATE, SELECT, USAGE ON SEQUENCES TO authenticated;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public GRANT UPDATE, SELECT, USAGE ON SEQUENCES TO service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT UPDATE, SELECT, USAGE ON SEQUENCES TO postgres;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT UPDATE, SELECT, USAGE ON SEQUENCES TO anon;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT UPDATE, SELECT, USAGE ON SEQUENCES TO authenticated;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT UPDATE, SELECT, USAGE ON SEQUENCES TO service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT INSERT, DELETE, TRUNCATE, UPDATE, TRIGGER, SELECT, REFERENCES, MAINTAIN ON TABLES TO postgres;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT INSERT, DELETE, TRUNCATE, UPDATE, TRIGGER, SELECT, REFERENCES, MAINTAIN ON TABLES TO anon;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT INSERT, DELETE, TRUNCATE, UPDATE, TRIGGER, SELECT, REFERENCES, MAINTAIN ON TABLES TO authenticated;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT INSERT, DELETE, TRUNCATE, UPDATE, TRIGGER, SELECT, REFERENCES, MAINTAIN ON TABLES TO service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO postgres;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO anon;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO authenticated;
ALTER DEFAULT PRIVILEGES FOR ROLE supabase_admin IN SCHEMA public GRANT EXECUTE ON FUNCTIONS TO service_role;
